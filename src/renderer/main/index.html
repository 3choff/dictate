<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dictate</title>
    <link rel="stylesheet" href="../main/styles.css">
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="drag-indicator-container">
                <div class="drag-indicator"></div>
            </div>
            <div class="close-button" id="close-btn">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 1L11 11M1 11L11 1" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
        </div>
        <div class="main-content">
            <div class="icon-button settings-icon">
                <svg viewBox="0 0 32 32" enable-background="new 0 0 32 32" id="Editable-line" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><circle cx="16" cy="16" fill="none" id="XMLID_224_" r="4" stroke="#e8eaed" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="2"></circle><path d=" M27.758,10.366l-1-1.732c-0.552-0.957-1.775-1.284-2.732-0.732L23.5,8.206C21.5,9.36,19,7.917,19,5.608V5c0-1.105-0.895-2-2-2h-2 c-1.105,0-2,0.895-2,2v0.608c0,2.309-2.5,3.753-4.5,2.598L7.974,7.902C7.017,7.35,5.794,7.677,5.242,8.634l-1,1.732 c-0.552,0.957-0.225,2.18,0.732,2.732L5.5,13.402c2,1.155,2,4.041,0,5.196l-0.526,0.304c-0.957,0.552-1.284,1.775-0.732,2.732 l1,1.732c0.552,0.957,1.775,1.284,2.732,0.732L8.5,23.794c2-1.155,4.5,0.289,4.5,2.598V27c0,1.105,0.895,2,2,2h2 c1.105,0,2-0.895,2-2v-0.608c0-2.309,2.5-3.753,4.5-2.598l0.526,0.304c0.957,0.552,2.18,0.225,2.732-0.732l1-1.732 c0.552-0.957,0.225-2.18-0.732-2.732L26.5,18.598c-2-1.155-2-4.041,0-5.196l0.526-0.304C27.983,12.546,28.311,11.323,27.758,10.366z " fill="none" id="XMLID_242_" stroke="#e8eaed" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="2"></path></g></svg>
            </div>
            <div class="mic-button">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M14.5 10.5V5.5C14.5 4.11929 13.3807 3 12 3C10.6193 3 9.5 4.11929 9.5 5.5V10.5C9.5 11.8807 10.6193 13 12 13C13.3807 13 14.5 11.8807 14.5 10.5ZM12 1C9.51472 1 7.5 3.01472 7.5 5.5V10.5C7.5 12.9853 9.51472 15 12 15C14.4853 15 16.5 12.9853 16.5 10.5V5.5C16.5 3.01472 14.4853 1 12 1Z" fill="#8ab4f8"></path> <path d="M12 17C5.49999 17 5.99999 12 5.99999 12C5.99999 12 6.00001 11 5.00001 11C4.00001 11 3.99999 12 3.99999 12C3.99999 12 3.54013 18.4382 11 18.9657V22C11 22.5523 11.4477 23 12 23C12.5523 23 13 22.5523 13 22V18.9657C20.4599 18.4382 20 12 20 12C20 12 20 11 19 11C18 11 18 12 18 12C18 12 18.5 17 12 17Z" fill="#8ab4f8"></path> </g></svg>
            </div>
            <div class="icon-button help-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M23 12C23 18.0751 18.0751 23 12 23C5.92487 23 1 18.0751 1 12C1 5.92487 5.92487 1 12 1C18.0751 1 23 5.92487 23 12ZM3.00683 12C3.00683 16.9668 7.03321 20.9932 12 20.9932C16.9668 20.9932 20.9932 16.9668 20.9932 12C20.9932 7.03321 16.9668 3.00683 12 3.00683C7.03321 3.00683 3.00683 7.03321 3.00683 12Z" fill="#e8eaed"></path> <path d="M13.5 18C13.5 18.8284 12.8284 19.5 12 19.5C11.1716 19.5 10.5 18.8284 10.5 18C10.5 17.1716 11.1716 16.5 12 16.5C12.8284 16.5 13.5 17.1716 13.5 18Z" fill="#e8eaed"></path> <path d="M11 12V14C11 14 11 15 12 15C13 15 13 14 13 14V12C13 12 13.4792 11.8629 13.6629 11.7883C13.6629 11.7883 13.9969 11.6691 14.2307 11.4896C14.4646 11.3102 14.6761 11.097 14.8654 10.8503C15.0658 10.6035 15.2217 10.3175 15.333 9.99221C15.4443 9.66693 15.5 9.4038 15.5 9C15.5 8.32701 15.3497 7.63675 15.0491 7.132C14.7596 6.61604 14.3476 6.21786 13.8132 5.93745C13.2788 5.64582 12.6553 5.5 11.9427 5.5C11.4974 5.5 11.1021 5.55608 10.757 5.66825C10.4118 5.7692 10.1057 5.9094 9.83844 6.08887C9.58236 6.25712 9.36525 6.4478 9.18711 6.66091C9.02011 6.86281 8.8865 7.0591 8.78629 7.24978C8.68609 7.44046 8.61929 7.6087 8.58589 7.75452C8.51908 7.96763 8.49125 8.14149 8.50238 8.27609C8.52465 8.41069 8.59145 8.52285 8.70279 8.61258C8.81413 8.70231 8.9867 8.79765 9.22051 8.8986C9.46546 8.97712 9.65473 9.00516 9.78834 8.98273C9.93308 8.96029 10.05 8.89299 10.1391 8.78083C10.1391 8.78083 10.6138 8.10569 10.7474 7.97109C10.8922 7.82528 11.0703 7.71312 11.2819 7.6346C11.4934 7.54487 11.7328 7.5 12 7.5C12.579 7.5 13.0076 7.64021 13.286 7.92062C13.5754 8.18982 13.6629 8.41629 13.6629 8.93225C13.6629 9.27996 13.6017 9.56038 13.4792 9.77349C13.3567 9.9866 13.1953 10.1605 12.9949 10.2951C12.9949 10.2951 12.7227 10.3991 12.5 10.5C12.2885 10.5897 11.9001 10.7381 11.6997 10.8503C11.5104 10.9512 11.4043 11.0573 11.2819 11.2144C11.1594 11.3714 11 11.7308 11 12Z" fill="#e8eaed"></path> </g></svg>
            </div>
        </div>
    </div>
    <script src="../../shared/deepgram.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const closeBtn = document.getElementById('close-btn');
        const settingsIcon = document.querySelector('.settings-icon');
        const helpButton = document.querySelector('.help-icon');
        const micButton = document.querySelector('.mic-button');

        let mediaRecorder;
        let audioChunks = [];
        let dgSocket = null;
        let dgActive = false;

        let beepSound;
        let clackSound;

        async function loadAudio() {
          try {
            const beepBase64 = await window.electronAPI.getAssetBase64('assets/audio/beep.mp3');
            if (beepBase64) {
              beepSound = new Audio(`data:audio/mpeg;base64,${beepBase64}`);
            } else {
              console.error('Failed to load beep sound data.');
            }

            const clackBase64 = await window.electronAPI.getAssetBase64('assets/audio/clack.mp3');
            if (clackBase64) {
              clackSound = new Audio(`data:audio/mpeg;base64,${clackBase64}`);
            } else {
              console.error('Failed to load clack sound data.');
            }

            if(beepSound) beepSound.addEventListener('error', (e) => console.error('beep load/play error', e));
            if(clackSound) clackSound.addEventListener('error', (e) => console.error('clack load/play error', e));

          } catch (error) {
            console.error('Error loading audio assets:', error);
          }
        }

        closeBtn.addEventListener('click', () => {
          window.electronAPI.closeWindow();
        });

        settingsIcon.addEventListener('click', () => {
          window.electronAPI.openSettingsWindow();
        });

        helpButton.addEventListener('click', () => {
            window.electronAPI.openExternalLink('https://github.com/3choff/dictate');
        });

        window.electronAPI.onToggleMic(() => {
          micButton.click();
        });

        micButton.addEventListener('click', async () => {
          const isRecording = micButton.classList.contains('recording');

          if (isRecording) {
            if (clackSound) clackSound.play().catch((e) => console.error('clack play failed', e));
          } else {
            if (beepSound) beepSound.play().catch((e) => console.error('beep play failed', e));
          }

          micButton.classList.toggle('recording');

          if (mediaRecorder && mediaRecorder.state === 'recording') {
            try { mediaRecorder.stop(); } catch (e) { /* ignore */ }
            if (dgActive && dgSocket) {
              try { dgSocket.send(JSON.stringify({ type: 'CloseStream' })); } catch (_) {}
              try { dgSocket.close(); } catch (_) {}
              dgSocket = null;
              dgActive = false;
            }
          } else {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const settings = await window.electronAPI.getSettings();
              const dgKey = ((settings && (settings.deepgramApiKey || settings.apiKey)) || '').trim();
              const useDeepgram = settings.apiService === 'deepgram' && dgKey.length > 0;

              audioChunks = [];

              if (useDeepgram) {
                dgActive = true;
                const pref = (window.Deepgram && Deepgram.pickPreferredMime) ? Deepgram.pickPreferredMime() : { mimeType: undefined, encoding: undefined };
                mediaRecorder = new MediaRecorder(stream, pref.mimeType ? { mimeType: pref.mimeType } : undefined);

                const wsUrl = (window.Deepgram && Deepgram.buildUrl) ? Deepgram.buildUrl({ encoding: pref.encoding }) : 'wss://api.deepgram.com/v1/listen';
                try {
                  dgSocket = (window.Deepgram && Deepgram.createSocket) ? Deepgram.createSocket(dgKey, wsUrl) : new WebSocket(wsUrl, ['token', dgKey]);
                } catch (e) {
                  console.error('Deepgram WS open failed', e);
                  dgActive = false;
                }

                if (dgSocket) {
                  dgSocket.onopen = () => {
                    mediaRecorder.ondataavailable = (event) => {
                      if (event.data && event.data.size > 0 && dgSocket && dgSocket.readyState === WebSocket.OPEN) {
                        dgSocket.send(event.data);
                      }
                    };
                    try { mediaRecorder.start(250); } catch (e) { mediaRecorder.start(); }
                  };
                  dgSocket.onmessage = (event) => {
                    try {
                      const msg = JSON.parse(event.data);
                      if (msg.type === 'Results' && msg.channel && msg.channel.alternatives && msg.channel.alternatives[0]) {
                        const alt = msg.channel.alternatives[0];
                        if (alt.transcript && (msg.is_final || msg.speech_final)) {
                          const transcript = alt.transcript.trim();
                          const finalTranscript = transcript + ' ';
                          window.electronAPI.insertText(finalTranscript);
                        }
                      }
                    } catch (e) { /* ignore */ }
                  };
                  dgSocket.onerror = (e) => console.error('Deepgram WS error', e);
                  dgSocket.onclose = () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                      try { mediaRecorder.stop(); } catch (_) {}
                    }
                    dgActive = false;
                    dgSocket = null;
                  };
                } else {
                  mediaRecorder = new MediaRecorder(stream);
                  mediaRecorder.ondataavailable = (event) => { audioChunks.push(event.data); };
                  mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioBuffer = await audioBlob.arrayBuffer();
                    const audioData = new Uint8Array(audioBuffer);
                    window.electronAPI.saveAudio(audioData);
                  };
                  mediaRecorder.start();
                }
              } else {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => { audioChunks.push(event.data); };
                mediaRecorder.onstop = async () => {
                  const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                  const audioBuffer = await audioBlob.arrayBuffer();
                  const audioData = new Uint8Array(audioBuffer);
                  window.electronAPI.saveAudio(audioData);
                };
                mediaRecorder.start();
              }
            } catch (err) {
              console.error('Error accessing microphone:', err);
              micButton.classList.remove('recording');
            }
          }
        });

        loadAudio();
      });
    </script>
</body>
</html>
